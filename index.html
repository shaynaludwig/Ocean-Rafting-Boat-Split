<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ocean Rafting — Boat Split</title>
<style>
  :root{
    --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --panel:#ffffff;
    --brand:#2563eb; --brand-600:#1d4ed8; --shadow:0 6px 18px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       scrollbar-gutter:stable both-edges;}
  header{padding:18px 20px;border-bottom:1px solid var(--line);background:#fff}
  header h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px}
  header p{margin:2px 0 0;color:var(--muted);font-size:13px}
  .container{max-width:1120px;margin:0 auto;padding:20px 16px 32px;}
  .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;
           padding:16px;box-shadow:var(--shadow);margin-bottom:16px;}
  .section-title{margin:0 0 12px;font-weight:800;letter-spacing:.2px;font-size:13px;color:#374151;text-transform:uppercase;}
  label{display:block;margin:8px 0 6px;color:#374151}
  input[type="file"],select,input[type="number"],input[type="text"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
    background:#fff;color:#111827;outline:none
  }
  input[type="file"]{padding:8px 10px}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;
       border:1px solid var(--line);background:#fff;color:#111827;cursor:pointer;text-decoration:none}
  .btn:hover{background:#f3f4f6}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-primary:hover{background:var(--brand-600)}
  .btn-danger{background:#fff;border-color:#fca5a5;color:#b91c1c}
  .btn-danger:hover{background:#fee2e2}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .boats{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:680px){.boats{grid-template-columns:1fr 1fr}}
  @media(min-width:980px){.boats{grid-template-columns:1fr 1fr 1fr}}
  .boat{border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .just{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .boat h4{margin:0 0 6px;font-size:15px}
  .controls-inline{display:flex;gap:6px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>*{flex:1 1 120px}
  .row-tight{gap:6px}
  .tagline label{display:flex;align-items:center;gap:6px;margin:0}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:#eef2ff;border:1px solid #c7d2fe;color:#1f2937;
        padding:5px 8px;border-radius:999px;font-size:12px;white-space:nowrap}
  .pill{display:inline-block;padding:4px 9px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  .tag{background:#eff6ff;border-color:#bfdbfe;color:#1e3a8a}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:#f3f4f6;color:#111827;text-align:left;font-weight:800;border-bottom:1px solid var(--line);padding:10px 8px}
  tbody td{border-bottom:1px solid var(--line);padding:10px 8px}
  tbody tr:nth-child(2n){background:#fafafa}
  tbody tr:hover{background:#f5f5f5}
  .err{white-space:pre-wrap;background:#fff1f2;color:#881337;border:1px solid #fecdd3;border-radius:10px;padding:10px;margin:12px 0}
</style>
</head>
<body>
<header>
  <h1>Boat Split</h1>
  <p>Upload CSV → tag boats (DDI / Fly / EE) → remove boats (×) → Allocate → Download CSV</p>
</header>

<main class="container" id="app">
  <div class="section">
    <div class="section-title">Upload file</div>
    <input type="file" id="file" accept=".csv" />
    <div class="muted" style="margin-top:6px">
      Columns expected (flexible names): <span class="mono chip">Client</span> <span class="mono chip">No. Pass.</span>
      <span class="mono chip">P/U Point</span> <span class="mono chip">Time</span> <span class="mono chip">Pickup Notes</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Tour & actions</div>
    <div class="row">
      <label style="max-width:280px">Tour
        <select id="tour"><option value="north">Northern</option><option value="south">Southern</option></select>
      </label>
    </div>
    <div class="toolbar">
      <button id="resetBoats" class="btn">Reset boats</button>
      <button id="run" class="btn btn-primary">Allocate</button>
      <button id="download" class="btn" disabled>Download CSV</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px">Booting...</div>
    <div id="messages" class="chips" style="margin-top:10px"></div>
  </div>

  <div class="section">
    <div class="section-title">Boats in order (earliest → latest)</div>
    <div class="muted" style="margin-bottom:8px">
      Reorder (▲/▼), set tags (DDI / Fly-Raft / EE), hold seats, or remove with ×. DDI & Fly are mutually exclusive.
    </div>
    <div id="boats" class="boats"></div>
  </div>

  <div class="section">
    <div class="section-title">Results</div>
    <div id="results" class="muted">Upload a CSV and click <b>Allocate</b>.</div>
  </div>
</main>

<script>
/* ===== Error banner so init errors show up in-page ===== */
(function(){
  var prev = window.onerror;
  window.onerror = function(msg, src, line, col, err){
    try{
      var host = document.getElementById('results');
      if(host){
        var pre = document.createElement('div');
        pre.className = 'err';
        pre.textContent = 'Script error:\n' + msg + '\n' + (src?('at '+src+':'+line+':'+col):'') + '\n' + (err && err.stack ? err.stack : '');
        host.prepend(pre);
      }
    }catch(_){}
    if(prev) return prev(msg, src, line, col, err);
  };
})();

/* ========= Helpers ========= */
function el(id){ return document.getElementById(id); }
function setStatus(s){ var n=el('status'); if(n) n.textContent = s; }
function pushMsg(text,tone){
  var messagesEl=document.getElementById('messages'); if(!messagesEl) return;
  var m=document.createElement('span'); m.className='chip';
  var col = tone==='ok'?'#16a34a':tone==='warn'?'#f59e0b':tone==='bad'?'#ef4444':'#c7d2fe';
  m.style.borderColor=col; m.textContent=text; messagesEl.appendChild(m);
}
function clearMsgs(){ var messagesEl=document.getElementById('messages'); if(messagesEl) messagesEl.innerHTML=''; }
function norm(s){ return (s==null?'':String(s)).trim(); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,function(m){ return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]; }); }
function edgeOrder(n){ var res=[]; for(var a=0,b=n-1;a<=b;a++,b--){ res.push(a); if(b>a) res.push(b);} return res; }
function sectionRank(s){ var map={'Unknown':0,'4th':1,'3rd':2,'2nd':3,'1st':4}; return map[s]||0; }
function boatStyleForName(name){
  var n=(name||'').toLowerCase();
  if(n.indexOf('joyride')>-1)       return { bg:'#ddd6fe', fg:'#1f2937', br:'#c4b5fd' };
  if(n.indexOf('black betty')>-1)   return { bg:'#111827', fg:'#ffffff', br:'#0b0f1a' };
  if(n.indexOf('thunderstruck')>-1) return { bg:'#fecaca', fg:'#1f2937', br:'#fca5a5' };
  if(n.indexOf('wipeout')>-1)       return { bg:'#ffffff', fg:'#111827', br:'#e5e7eb' };
  if(n.indexOf('thrilla')>-1)       return { bg:'#fef3c7', fg:'#1f2937', br:'#fde68a' };
  if(n.indexOf('jammin')>-1)        return { bg:'#dcfce7', fg:'#1f2937', br:'#bbf7d0' };
  if(n.indexOf('wildthing')>-1)     return { bg:'#dbeafe', fg:'#1f2937', br:'#bfdbfe' };
  if(n.indexOf('riptide')>-1)       return { bg:'#f1f5f9', fg:'#1f2937', br:'#e2e8f0' };
  return { bg:'#ffffff', fg:'#111827', br:'#e5e7eb' };
}

/* ========= Defaults ========= */
var DEFAULT_BOATS = [
  { name: "Joyride",        seats: 32, toilet: true },
  { name: "Thunderstruck",  seats: 32, toilet: true },
  { name: "Black Betty",    seats: 32, toilet: true },
  { name: "Wipeout",        seats: 32, toilet: true },
  { name: "Riptide",        seats: 32, toilet: true },
  { name: "Thrilla",        seats: 25, toilet: false },
  { name: "Jammin",         seats: 22, toilet: true },
  { name: "Wildthing",      seats: 19, toilet: false }
];

var boats = [];
var rows = [];
var ignoredCharter = [];
var popups = [];

/* ========= CSV parsing ========= */
function parseCSV(text){
  var res=[], cur='', row=[], inQ=false, i=0, ch;
  while(i<text.length){
    ch=text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur += '"'; i+=2; continue; }
        inQ=false; i++; continue;
      }
      cur += ch; i++; continue;
    }
    if(ch === '"'){ inQ=true; i++; continue; }
    if(ch === ','){ row.push(cur); cur=''; i++; continue; }
    if(ch === '\r'){ i++; continue; }
    if(ch === '\n'){ row.push(cur); res.push(row); row=[]; cur=''; i++; continue; }
    cur += ch; i++;
  }
  row.push(cur); res.push(row);
  // drop rows that are entirely blank (anywhere in file)
  return res.filter(function(r){ for(var k=0;k<r.length;k++){ if(norm(r[k])!=='') return true; } return false; });
}

var COL_ALIASES = {
  client:["client","name","full name","passenger","pax name"],
  num:["no. pass.","no pass","passengers","pax","qty","count"],
  pu:["p/u point","pickup point","p/u","pick up","pickup","location","p/u address","pickup address"],
  time:["time","pickup time","p/u time"],
  notes:["pickup notes","notes","comments","pu comments","p/u notes"],
  phone:["phone","mobile"]
};

function findColIndex(h,keys){
  var lower=h.map(function(x){ return String(x).toLowerCase(); });
  for(var k=0;k<keys.length;k++){ var idx=lower.indexOf(keys[k]); if(idx!==-1) return idx; }
  for(var i=0;i<lower.length;i++){
    for(var j=0;j<keys.length;j++){ if(lower[i].indexOf(keys[j])>-1) return i; }
  }
  return -1;
}

function parseTimeToSortable(t){
  if(!t) return null; var s=String(t).trim(); if(!s) return null;
  s=s.replace('.',':');
  var ampm=null, m=s.match(/am|pm/i); if(m) ampm=m[0].toLowerCase();
  s=s.replace(/[^0-9:]/g,'');
  if(/^\d{3,4}$/.test(s)){ if(s.length===3) s='0'+s; s=s.slice(0,2)+':'+s.slice(2); }
  if(!/^\d{1,2}:\d{2}$/.test(s)) return null;
  var hh=parseInt(s.split(':')[0],10), mm=parseInt(s.split(':')[1],10);
  if(ampm){ if(ampm==='pm'&&hh<12)hh+=12; if(ampm==='am'&&hh===12)hh=0; }
  if(hh>=0&&hh<24&&mm>=0&&mm<60) return hh*60+mm;
  return null;
}

function quartileSection(mins, sortedDistinct){
  if(mins==null) return 'Unknown';
  var n=sortedDistinct.length; if(!n) return 'Unknown';
  var q1=sortedDistinct[Math.floor(n*.25)], q2=sortedDistinct[Math.floor(n*.50)], q3=sortedDistinct[Math.floor(n*.75)];
  if(mins<=q1) return '1st'; if(mins<=q2) return '2nd'; if(mins<=q3) return '3rd'; return '4th';
}

/* ========= Boats UI ========= */
function cloneBoats(){ return DEFAULT_BOATS.map(function(b){ return {name:b.name,seats:b.seats,toilet:b.toilet,tagDDI:false,tagFly:false,tagEE:false,hold:0}; }); }

function renderBoats(){
  var wrap = document.getElementById('boats');
  if (!wrap) { setStatus('Boats container missing.'); return; }
  try{
    wrap.innerHTML='';
    if(!boats || !Array.isArray(boats)) boats = [];
    if(!boats.length) boats = cloneBoats();

    boats.forEach(function(b,idx){
      var style = boatStyleForName(b.name);
      var box=document.createElement('div'); box.className='boat';
      box.style.background = style.bg; box.style.color = style.fg; box.style.borderColor = style.br;
      box.innerHTML =
        '<div class="just">'+
          '<div>'+
            '<h4 style="color:'+style.fg+'">'+(idx+1)+'. '+b.name+' '+(b.toilet?'🚻':'')+'</h4>'+
            '<div style="font-size:12px; color:'+style.fg+'">'+b.seats+' seats'+(b.toilet?', toilet':'')+'</div>'+
          '</div>'+
          '<div class="controls-inline">'+
            '<button class="btn" data-act="up" data-idx="'+idx+'" title="Earlier">▲</button>'+
            '<button class="btn" data-act="down" data-idx="'+idx+'" title="Later">▼</button>'+
            '<button class="btn btn-danger" data-act="remove" data-idx="'+idx+'" title="Remove boat">×</button>'+
          '</div>'+
        '</div>'+
        '<div class="row row-tight" style="margin-top:8px; align-items:center">'+
          '<div class="tagline" style="display:flex; gap:10px; flex-wrap:wrap">'+
            '<label><input type="checkbox" data-act="ddi" data-idx="'+idx+'" '+(b.tagDDI?'checked':'')+'/> DDI</label>'+
            '<label><input type="checkbox" data-act="fly" data-idx="'+idx+'" '+(b.tagFly?'checked':'')+'/> Fly-Raft</label>'+
            '<label><input type="checkbox" data-act="ee"  data-idx="'+idx+'" '+(b.tagEE?'checked':'')+'/> EE</label>'+
          '</div>'+
          '<div style="flex:1"></div>'+
          '<label style="margin:0; flex:0 0 160px">Hold seats '+
            '<input type="number" data-act="hold" data-idx="'+idx+'" min="0" max="'+b.seats+'" value="'+(b.hold||0)+'" />'+
          '</label>'+
        '</div>';
      wrap.appendChild(box);
    });

    [].slice.call(wrap.querySelectorAll('button')).forEach(function(btn){
      btn.onclick=function(){
        var idx=+btn.getAttribute('data-idx'), act=btn.getAttribute('data-act');
        if(act==='up'&&idx>0){ var t=boats[idx-1]; boats[idx-1]=boats[idx]; boats[idx]=t; renderBoats(); }
        if(act==='down'&&idx<boats.length-1){ var t2=boats[idx+1]; boats[idx+1]=boats[idx]; boats[idx]=t2; renderBoats(); }
        if(act==='remove'){ boats.splice(idx,1); renderBoats(); setStatus('Boat removed.'); }
      };
    });
    [].slice.call(wrap.querySelectorAll('input')).forEach(function(inp){
      inp.onchange=function(){
        var idx=+inp.getAttribute('data-idx'), act=inp.getAttribute('data-act');
        if(act==='ddi'){ boats[idx].tagDDI=inp.checked; if(inp.checked) boats[idx].tagFly=false; }
        if(act==='fly'){ boats[idx].tagFly=inp.checked; if(inp.checked) boats[idx].tagDDI=false; }
        if(act==='ee'){ boats[idx].tagEE=inp.checked; }
        if(act==='hold'){
          var v=parseInt(inp.value||'0',10); if(isNaN(v)) v=0;
          if(v<0) v=0; if(v>boats[idx].seats) v=boats[idx].seats; boats[idx].hold=v; inp.value=String(v);
        }
        renderBoats();
      };
    });
  }catch(e){
    var errBox=document.createElement('div');
    errBox.className='err';
    errBox.textContent='Boats render error: '+ (e && e.stack ? e.stack : String(e));
    wrap.parentElement.prepend(errBox);
  }
}

/* ========= Allocation ========= */
function allocate(){
  clearMsgs(); popups = [];
  if(!rows.length){ setStatus('Please upload a CSV first.'); return; }
  if(!boats.length){ setStatus('No boats in use. Click "Reset boats".'); return; }

  var B = boats.map(function(b){
    return { name:b.name, seats:b.seats, toilet:b.toilet,
      tagDDI:!!b.tagDDI, tagFly:!!b.tagFly, tagEE:!!b.tagEE,
      hold: Math.max(0,Math.min(b.hold||0,b.seats)), pax:[], count:0, twGroups:new Set()
    };
  });
  function eff(b){ return Math.max(0,b.seats-b.hold); }
  var edges = edgeOrder(B.length);
  var lastIdx = edges[1] != null ? edges[1] : (B.length-1);
  var edgeBoats = edges.map(function(i){ return {i:i,b:B[i]}; });
  function tagOrder(tag){ return edgeBoats.filter(function(o){ return !!o.b['tag'+tag]; }); }
  function sectionEdgeOrder(section){
    if(section==='1st'||section==='2nd'){
      var wl=edges.filter(function(i){ return i!==lastIdx; });
      return wl.concat([lastIdx]);
    }
    return edges.slice();
  }
  function addPax(i,r,tags,hl){
    if(!tags) tags=[]; if(!hl) hl=[];
    var need=r.num||1; var b=B[i];
    b.pax.push({row:r,count:need,tags:new Set(tags),highlights:new Set(hl)});
    b.count+=need;
  }

  var distinct = rows.map(function(r){ return r.timeMins; }).filter(function(v){ return v!=null; }).sort(function(a,b){ return a-b; }).filter(function(v,i,a){ return !i || v!==a[i-1]; });
  rows.forEach(function(r){ r.section = quartileSection(r.timeMins, distinct); });

  // classifiers
  function isDDI(r){ return /daydream\s*island/i.test(r.pu); }
  function isOwn(r){ return /(own\s*way|tbc|not\s*sure|tba)/i.test(r.pu); }
  function isEE(r){ return /\bee\b/i.test(r.notes||''); }
  function noteFly(r){ return /(fly[-\s]*raft|fly\s*raft)/i.test(r.notes||''); }
  function hasFR(r){ return /\(\s*F\s*\+\s*R\s*\)/i.test(r.clientRaw) || r.flyFromCount || noteFly(r); }
  function earlyBoat(r){ return /early\s*boat/i.test(r.notes||''); }
  function charter(r){ return /charter/i.test(r.pu); }
  function wHoldName(r){ return /\bweather\s*hold\b/i.test(r.clientRaw); }

  // prepare rows
  var prepared = rows.slice();
  ignoredCharter = prepared.filter(function(r){ return charter(r); });
  var filtered = prepared.filter(function(r){ return !wHoldName(r) && !charter(r); });
  var unassigned = new Set(filtered);

  // *TW* indexing
  function baseName(clientRaw){ return norm(clientRaw.replace(/\*TW\*.*$/i,'')); }
  function parseTW(row){ var m = row.clientRaw.match(/\*TW\*\s*(.+)$/i); return m?norm(m[1]):null; }
  var byName = new Map();
  filtered.forEach(function(r){
    r.nameClean = baseName(r.clientRaw);
    r.twPartner = parseTW(r);
    var arr = byName.get(r.nameClean) || [];
    arr.push(r); byName.set(r.nameClean, arr);
  });
  var twGroups = new Map(); var twErrors=[];
  filtered.forEach(function(r){
    if(!r.twPartner) return;
    var anchor = norm(r.twPartner);
    var partners = byName.get(anchor) || [];
    if(partners.length===0){ twErrors.push('*TW* reference not found: "'+r.clientRaw+'" → "'+anchor+'"'); return; }
    if(partners.length>1){ twErrors.push('*TW* ambiguous anchor: "'+anchor+'" — please disambiguate.'); return; }
    var arr = twGroups.get(anchor)||[];
    if(arr.indexOf(partners[0])===-1) arr.push(partners[0]);
    if(arr.indexOf(r)===-1) arr.push(r);
    twGroups.set(anchor, arr);
  });
  if(twErrors.length){ popups.push(twErrors.join('\n')); }

  filtered.forEach(function(r){ if(isDDI(r)) r.section='1st'; if(hasFR(r)) r.section='Unknown'; });

  /* ===== 1) DDI STRICT ===== */
  var ddiBoats = tagOrder('DDI');
  var ddiRows = filtered.filter(isDDI);
  if(ddiRows.length && ddiBoats.length===0 && B.length){
    B[0].tagDDI=true; ddiBoats=tagOrder('DDI'); pushMsg('Auto-tagged earliest boat as DDI.','warn');
  }
  var ddiCap = ddiBoats.reduce(function(s,o){ return s+(eff(o.b)-o.b.count); },0);
  var ddiNeed = ddiRows.reduce(function(s,r){ return s+(r.num||1); },0);
  if(ddiNeed>ddiCap) popups.push('Not enough space on DDI boat(s). Tag another DDI or redo run sheet.');
  ddiRows.forEach(function(r){
    if(!unassigned.has(r)) return; var need=r.num||1;
    for(var x=0;x<ddiBoats.length;x++){
      var i=ddiBoats[x].i, b=B[i];
      if(b.count+need<=eff(b)){ addPax(i,r,['DDI']); unassigned.delete(r); break; }
    }
  });

  /* ===== 2) F+R STRICT ===== */
  var flyRows = filtered.filter(function(r){ return hasFR(r) && !earlyBoat(r); })
    .sort(function(a,b){
      function rank(s){ var m={'Unknown':0,'4th':1,'3rd':2,'2nd':3,'1st':4}; return m[s]||5; }
      var ra=rank(a.section), rb=rank(b.section); if(ra!==rb) return ra-rb;
      return (b.timeMins||-1)-(a.timeMins||-1);
    });
  var flyBoats = tagOrder('Fly');
  if(flyRows.length && flyBoats.length===0){
    var last = edges[1]!=null?edges[1]:(B.length-1); B[last].tagFly=true; flyBoats=tagOrder('Fly');
    pushMsg('No Fly boat tagged — auto-tagged latest boat.','warn');
  }
  var flyCap = flyBoats.reduce(function(s,o){ return s+(eff(o.b)-o.b.count); },0);
  var flyNeed = flyRows.reduce(function(s,r){ return s+(r.num||1); },0);
  if(flyNeed>flyCap) popups.push('Not enough space on Fly-Raft boat(s). Tag another Fly-Raft or redo run sheet.');
  flyRows.forEach(function(r){
    if(!unassigned.has(r)) return; var need=r.num||1; var placed=false;
    var rev=flyBoats.slice().reverse();
    for(var y=0;y<rev.length;y++){
      var i=rev[y].i, b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,['F+R']); unassigned.delete(r); placed=true; break; }
    }
  });

  /* ===== Local swap helper ===== */
  function tryMakeRoomWithSwap(targetIdx, need, refSec){
    var target = B[targetIdx];
    var refRank = sectionRank(refSec);
    var laterIdx = edges.filter(function(i){ return i > targetIdx; });
    var freed = 0;
    for(var k = target.pax.length - 1; k >= 0 && freed < need; k--){
      var entry = target.pax[k];
      var row = entry.row;
      var cnt = entry.count;
      var donorRank = sectionRank(row.section);
      var donorIsDDI = entry.tags.has('DDI') || isDDI(row);
      var donorIsFR  = entry.tags.has('F+R') || hasFR(row);
      var donorIsTW  = Array.from(entry.highlights||[]).some(function(h){ return String(h).indexOf('*TW* grouped')>-1; });
      if(donorRank >= refRank) continue;
      if(donorIsDDI || donorIsTW) continue;
      for(var jI=0;jI<laterIdx.length;jI++){
        var j=laterIdx[jI], land=B[j];
        if(land.tagDDI) continue;
        if(donorIsFR && !land.tagFly) continue;
        if(land.count + cnt <= eff(land)){
          target.pax.splice(k,1); target.count -= cnt;
          addPax(j, row, Array.from(entry.tags), Array.from(entry.highlights).concat(['SWAP (freed earlier boat)']));
          freed += cnt; break;
        }
      }
    }
    return freed >= need;
  }

  /* ===== 3) *TW* AFTER DDI & F+R ===== */
  function referenceMember(arr){
    var known = arr.filter(function(r){ return r.section && r.section!=='Unknown'; });
    if(!known.length) return null;
    return known.sort(function(a,b){
      var ra=sectionRank(a.section), rb=sectionRank(b.section);
      if(rb!==ra) return rb-ra;
      return (b.timeMins||-1) - (a.timeMins||-1);
    })[0];
  }
  function isFRRow(r){ return hasFR(r); }
  function isDDIRow(r){ return isDDI(r); }

  twGroups.forEach(function(groupRaw, anchor){
    var group = Array.from(new Set(groupRaw));
    if(group.some(isDDIRow)){
      popups.push('*TW* group with "'+anchor+'" includes a DDI passenger. Consider changing PU times to keep them together.');
      return;
    }
    var need = group.reduce(function(s,r){ return s+(r.num||1); },0);
    var anyFR = group.some(isFRRow);
    var ref = referenceMember(group);
    var candidates=[];
    if(anyFR){
      var flyIdx = tagOrder('Fly').map(function(x){ return x.i; });
      if(!flyIdx.length){ popups.push('*TW* group "'+anchor+'" requires Fly-Raft but no Fly boat is tagged.'); return; }
      candidates = (ref && (ref.section==='1st'||ref.section==='2nd')) ? flyIdx.slice() : flyIdx.slice().reverse();
    }else{
      var notDDI = edges.filter(function(i){ return !B[i].tagDDI; });
      if(ref && (ref.section==='1st'||ref.section==='2nd')){
        var last2 = edges[1]!=null?edges[1]:(B.length-1);
        candidates = notDDI.filter(function(i){ return i!==last2; });
      }else if(ref && (ref.section==='3rd'||ref.section==='4th')){
        candidates = notDDI.slice().reverse();
      }else{
        candidates = notDDI.slice(1);
      }
    }
    var placedIdx = null;
    for(var c=0;c<candidates.length;c++){
      var i=candidates[c], b=B[i];
      var capLeft = eff(b) - b.count;
      if(capLeft >= need){ placedIdx = i; break; }
      var ok = tryMakeRoomWithSwap(i, need - capLeft, ref ? ref.section : 'Unknown');
      if(ok){ placedIdx = i; break; }
    }
    if(placedIdx==null){
      popups.push('*TW* group "'+anchor+'" could not fit on target boat(s)'+(anyFR?' (Fly-Raft)':'')+' even after swaps. Tag another boat, reduce holds, or adjust numbers.');
      return;
    }
    for(var bi=0; bi<B.length; bi++){
      var p=B[bi].pax;
      for(var k=p.length-1; k>=0; k--){
        if(group.indexOf(p[k].row)>-1){ var rem=B[bi].pax.splice(k,1)[0]; B[bi].count -= rem.count; }
      }
    }
    group.forEach(function(r){
      var tags=[]; if(isFRRow(r)) tags.push('F+R'); if(isEE(r)) tags.push('EE'); if(isDDIRow(r)) tags.push('DDI');
      addPax(placedIdx, r, tags, ['*TW* grouped (anchored to partner’s section)']);
      unassigned.delete(r);
    });
    B[placedIdx].twGroups.add(anchor);
  });

  /* ===== 4) EE ===== */
  var eeBoats = tagOrder('EE');
  filtered.filter(function(rr){ return isEE(rr) && unassigned.has(rr); }).forEach(function(r){
    var need=r.num||1;
    var earlyEE = (r.section==='1st'||r.section==='2nd');
    if(earlyEE && B.length>=3){
      var placed=false;
      sectionEdgeOrder(r.section).forEach(function(i){
        if(placed) return;
        var b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,['EE'], (r.section==='1st'?['EE kept early (1st section)']:[]) ); unassigned.delete(r); placed=true; }
      });
      if(placed) return;
    }
    var placed2=false;
    var eeLate = eeBoats.length?eeBoats.slice().reverse():[{i:lastIdx}];
    for(var e=0;e<eeLate.length;e++){
      var i=eeLate[e].i; var b=B[i];
      if(b.count+need<=eff(b)){ addPax(i,r,['EE'],[earlyEE?'Early EE moved later':'']); unassigned.delete(r); placed2=true; break; }
    }
    if(!placed2){
      for(var q=0;q<edgeBoats.length;q++){
        var i2=edgeBoats[q].i, b2=B[i2];
        if(b2.count+need<=eff(b2)){ addPax(i2,r,['EE'],['EE by capacity']); unassigned.delete(r); break; }
      }
    }
  });

  /* ===== 5) Baseline fill ===== */
  var orderSec={'1st':0,'2nd':1,'3rd':2,'4th':3,'Unknown':4};
  Array.from(unassigned).sort(function(a,b){
    var da=orderSec[a.section]||4, db=orderSec[b.section]||4;
    if(da!==db) return da-db;
    return (a.timeMins||1e9)-(b.timeMins||1e9);
  }).forEach(function(r){
    var need=r.num||1; var placed=false;
    sectionEdgeOrder(r.section).forEach(function(i){
      if(placed) return;
      var b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r); placed=true; }
    });
    if(!placed){
      for(var z=0; z<edgeBoats.length; z++){
        var i2=edgeBoats[z].i, b2=B[i2]; if(b2.count+need<=eff(b2)){ addPax(i2,r,[],['Capacity fallback']); placed=true; break; }
      }
    }
    if(placed) unassigned.delete(r);
  });

  /* ===== 6) RIPPLE-CHAIN FINAL FIT ===== */
  function canLand(entry, j){
    var land=B[j];
    if(land.tagDDI) return false;
    var donorIsFR = entry.tags && entry.tags.has && entry.tags.has('F+R') || hasFR(entry.row);
    if(donorIsFR && !land.tagFly) return false;
    return land.count + entry.count <= eff(land);
  }
  function listMovables(bi, refSec){
    var b=B[bi], refRank=sectionRank(refSec);
    var arr = b.pax.map(function(e,idx){ return {entry:e, idx:idx, secRank:sectionRank(e.row.section)}; }).filter(function(o){
      var e=o.entry;
      var donorIsDDI = e.tags.has('DDI') || isDDI(e.row);
      var donorIsTW  = Array.from(e.highlights||[]).some(function(h){ return String(h).indexOf('*TW* grouped')>-1; });
      if(donorIsDDI || donorIsTW) return false;
      return o.secRank < refRank;
    });
    arr.sort(function(a,b){
      if(a.secRank!==b.secRank) return a.secRank - b.secRank; // later sections first (Unknown/4th lowest rank numbers)
      if(a.entry.count!==b.entry.count) return a.entry.count - b.entry.count; // smaller groups first
      var ao = isOwn(a.entry.row)?0:1, bo=isOwn(b.entry.row)?0:1; if(ao!==bo) return ao - bo;
      return 0;
    });
    return arr;
  }
  function tryRippleFree(idx, remaining, refSec, visitedSet){
    if(remaining<=0) return true;
    var key = idx+'|'+remaining+'|'+refSec;
    if(visitedSet.has(key)) return false;
    visitedSet.add(key);

    var donors = listMovables(idx, refSec);
    for(var dI=0; dI<donors.length; dI++){
      var d = donors[dI], e=d.entry, cnt=e.count;
      for(var j=idx+1; j<B.length; j++){
        if(canLand(e, j)){
          B[idx].pax.splice(d.idx,1); B[idx].count -= cnt;
          addPax(j, e.row, Array.from(e.tags), Array.from(e.highlights).concat(['RIPPLE→']));
          if(tryRippleFree(idx, remaining - cnt, refSec, visitedSet)) return true;
          // backtrack
          var last=B[j].pax.pop(); B[j].count -= cnt;
          B[idx].pax.splice(d.idx,0,e); B[idx].count += cnt;
        }else{
          var needOnJ = cnt - (eff(B[j]) - B[j].count);
          if(needOnJ>0){
            if(tryRippleFree(j, needOnJ, e.row.section || 'Unknown', visitedSet) && canLand(e, j)){
              B[idx].pax.splice(d.idx,1); B[idx].count -= cnt;
              addPax(j, e.row, Array.from(e.tags), Array.from(e.highlights).concat(['RIPPLE→']));
              if(tryRippleFree(idx, remaining - cnt, refSec, visitedSet)) return true;
              var last2=B[j].pax.pop(); B[j].count -= cnt;
              B[idx].pax.splice(d.idx,0,e); B[idx].count += cnt;
            }
          }
        }
      }
    }
    return false;
  }
  function placeWithRipple(r){
    var need = r.num||1;
    var prefs = sectionEdgeOrder(r.section);
    for(var pI=0;pI<prefs.length;pI++){
      var i=prefs[pI], capLeft = eff(B[i]) - B[i].count;
      if(capLeft>=need){ addPax(i,r,[],['Final-fit']); return true; }
      var visited = new Set();
      if(tryRippleFree(i, need - capLeft, r.section || 'Unknown', visited)){
        addPax(i,r,[],['Final-fit (ripple)']); return true;
      }
    }
    return false;
  }
  Array.from(unassigned).forEach(function(r){
    if(placeWithRipple(r)){ unassigned.delete(r); }
  });

  /* ===== Render output ===== */
  var out=[["Boat","DepartureOrder","Boat Hold Seats","Boat Tags","Client","No. Pass.","P/U Point","Time","Pickup Notes","Phone","Tags","Highlights","Pickup Section"]];
  var results = el('results'); results.innerHTML='';
  var totalAllocated = 0, totalCapacity = 0;

  if(ignoredCharter.length){
    var warn=document.createElement('div'); warn.className='err';
    var list = ignoredCharter.slice(0,10).map(function(c){ return '• '+escapeHtml(c.clientRaw)+' (PU: '+escapeHtml(c.pu)+')'; }).join('\n');
    warn.textContent = 'Ignored '+ignoredCharter.length+' charter booking(s) — please ensure the charter boat is not being used.\n\nExamples:\n'+list+(ignoredCharter.length>10?'\n…':'');
    results.appendChild(warn);
  }

  B.forEach(function(b,idx){
    totalAllocated+=b.count; totalCapacity+=eff(b);
    var boatTags=[b.tagDDI?'DDI':'', b.tagFly?'Fly-Raft':'', b.tagEE?'EE':''].filter(function(s){return !!s;}).join('; ');
    var head=document.createElement('div');
    head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
    head.style.margin='8px 0 4px';
    head.innerHTML =
      '<div><b>'+(idx+1)+'. '+b.name+'</b> &nbsp; <span class="pill '+(b.count<=eff(b)?'ok':'bad')+'">'+b.count+'/'+eff(b)+'</span></div>'+
      '<div class="chips">'+
        (b.tagDDI?'<span class="chip">DDI</span>':'')+
        (b.tagFly?'<span class="chip">Fly-Raft</span>':'')+
        (b.tagEE?'<span class="chip">EE</span>':'')+
        (b.twGroups.size?'<span class="chip">TW groups: '+b.twGroups.size+'</span>':'')+
        (b.toilet?'<span class="chip">🚻</span>':'')+
      '</div>';
    results.appendChild(head);

    var table=document.createElement('table');
    table.innerHTML = '<thead><tr>'+
      '<th>#</th><th>Client</th><th>No. Pass.</th><th>P/U Point</th><th>Time</th><th>Section</th><th>Tags</th><th>Highlights</th>'+
    '</tr></thead>';
    var tb=document.createElement('tbody');

    if(b.hold>0){
      var tr=document.createElement('tr');
      tr.innerHTML='<td>—</td><td>SEAT HOLD</td><td>'+b.hold+'</td><td></td><td></td><td></td>'+
                   '<td><span class="pill tag">Hold</span></td>'+
                   '<td><span class="pill warn">Seats reserved; not for allocation</span></td>';
      tb.appendChild(tr);
      out.push([b.name,idx+1,b.hold,boatTags,'SEAT HOLD',b.hold,'','','','','Hold','Seats reserved; not for allocation','']);
    }

    b.pax.forEach(function(p,i){
      var tags=Array.from(p.tags), hl=Array.from(p.highlights);
      var tr=document.createElement('tr');
      tr.innerHTML =
        '<td>'+(i+1)+'</td>'+
        '<td>'+escapeHtml(p.row.clientRaw)+'</td>'+
        '<td>'+p.count+'</td>'+
        '<td>'+escapeHtml(p.row.pu)+'</td>'+
        '<td>'+(p.row.time||'')+'</td>'+
        '<td>'+p.row.section+'</td>'+
        '<td>'+tags.map(function(t){return '<span class="pill tag">'+t+'</span>';}).join(' ')+'</td>'+
        '<td>'+hl.filter(function(t){return !!t;}).map(function(t){return '<span class="pill warn">'+escapeHtml(t)+'</span>';}).join(' ')+'</td>';
      tb.appendChild(tr);
      out.push([b.name,idx+1,b.hold,boatTags,p.row.clientRaw,p.count,p.row.pu,p.row.time||'',p.row.notes||'',p.row.phone||'',tags.join('; '),hl.filter(function(t){return !!t;}).join('; '),p.row.section]);
    });
    table.appendChild(tb);
    results.appendChild(table);
  });

  /* ===== Overflow / Holding boat ===== */
  var overflow = Array.from(unassigned);
  if(overflow.length){
    var head=document.createElement('div');
    head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
    head.style.margin='12px 0 6px';
    var overCount = overflow.reduce(function(s,r){ return s+(r.num||1); },0);
    head.innerHTML = '<div><b>⚠ Overflow (Review)</b> &nbsp; <span class="pill bad">'+overCount+' pax</span></div>'+
                     '<div class="chips"><span class="chip">Unplaced — adjust holds/tags or add boat</span></div>';
    results.appendChild(head);

    var table=document.createElement('table');
    table.innerHTML = '<thead><tr>'+
      '<th>#</th><th>Client</th><th>No. Pass.</th><th>P/U Point</th><th>Time</th><th>Section</th><th>Tags</th><th>Why</th>'+
    '</tr></thead>';
    var tb=document.createElement('tbody');
    overflow.forEach(function(r,i){
      var tags=[]; if(isDDI(r)) tags.push('DDI'); if(hasFR(r)) tags.push('F+R'); if(isEE(r)) tags.push('EE');
      var tr=document.createElement('tr');
      tr.innerHTML =
        '<td>'+(i+1)+'</td>'+
        '<td>'+escapeHtml(r.clientRaw)+'</td>'+
        '<td>'+(r.num||1)+'</td>'+
        '<td>'+escapeHtml(r.pu)+'</td>'+
        '<td>'+(r.time||'')+'</td>'+
        '<td>'+r.section+'</td>'+
        '<td>'+tags.map(function(t){return '<span class="pill tag">'+t+'</span>';}).join(' ')+'</td>'+
        '<td><span class="pill bad">No capacity after ripple</span></td>';
      tb.appendChild(tr);
      out.push(['OVERFLOW','','','',r.clientRaw,r.num||1,r.pu,r.time||'',r.notes||'',r.phone||'',tags.join('; '),'Unplaced after ripple',r.section]);
    });
    table.appendChild(tb); results.appendChild(table);
  }

  var summary=document.createElement('div'); summary.className='status';
  summary.style.margin='10px 0 0';
  var totalOverflow = overflow.reduce(function(s,r){ return s+(r.num||1); },0);
  summary.innerHTML = 'Total allocated: <b>'+totalAllocated+'</b> / Effective capacity: <b>'+totalCapacity+'</b>'+(totalAllocated>totalCapacity?' <span class="pill bad">Over capacity</span>':'')+
    (totalOverflow?(' — Overflow (review): <b>'+totalOverflow+'</b>'):'');
  results.prepend(summary);

  // CSV Download
  function safeToCSV(rows){
    return rows.map(function(r){
      return r.map(function(v){
        if(v==null) return '';
        var s=String(v);
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(',');
    }).join('\n');
  }
  var csv = safeToCSV(out);
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob);
  var dl=document.getElementById('download');
  dl.onclick=function(){
    var stamp=new Date().toISOString().slice(0,10);
    var a=document.createElement('a'); a.href=url; a.download='boat-split-'+document.getElementById('tour').value+'-'+stamp+'.csv';
    document.body.appendChild(a); a.click(); a.remove();
  };
  dl.disabled=false;
  setStatus('Allocation complete.');
  if(popups.length) alert(popups.join('\n\n'));
}

/* ========= Wiring ========= */
function wire(){
  el('resetBoats').onclick=function(){ boats=cloneBoats(); renderBoats(); setStatus('Boats reset.'); };
  el('run').onclick=allocate;

  el('file').addEventListener('change', function(e){
    clearMsgs(); popups=[]; ignoredCharter = [];
    var f=e.target.files && e.target.files[0]; if(!f) return;
    var reader=new FileReader();
    reader.onload=function(){
      try{
        var text=String(reader.result||'');
        var raw = parseCSV(text);
        if(!raw.length){ setStatus('Empty CSV.'); return; }
        var header = raw[0].map(function(h){ return String(h).trim(); });
        var data = raw.slice(1);

        var idxClient=findColIndex(header,COL_ALIASES.client);
        var idxNum   =findColIndex(header,COL_ALIASES.num);
        var idxPU    =findColIndex(header,COL_ALIASES.pu);
        var idxTime  =findColIndex(header,COL_ALIASES.time);
        var idxNotes =findColIndex(header,COL_ALIASES.notes);
        var idxPhone =findColIndex(header,COL_ALIASES.phone);

        if(idxClient<0 || idxPU<0){ setStatus('Missing required columns: need at least Client and P/U Point.'); return; }

        var prepared = data
          .filter(function(r){ for(var k=0;k<r.length;k++){ if(norm(r[k])!=='') return true; } return false; })
          .map(function(r){
            var clientRaw = norm(r[idxClient]);
            var numRaw = (r[idxNum]==null?'':String(r[idxNum]));
            var FRfromCount  = /\(\s*F\s*\+\s*R\s*\)/i.test(numRaw);
            var FRfromClient = /\(\s*F\s*\+\s*R\s*\)/i.test(clientRaw);
            var FRfromNotes  = /\(\s*F\s*\+\s*R\s*\)/i.test(norm(idxNotes>=0?r[idxNotes]:'')); 
            var flyFromAny   = FRfromCount || FRfromClient || FRfromNotes;

            var numMatch = numRaw.match(/\d+/);
            var num = Math.max(1, numMatch ? parseInt(numMatch[0],10) : 1);

            var pu   = norm(r[idxPU]);
            var time = norm(idxTime>=0?r[idxTime]:'');
            var notes= norm(idxNotes>=0?r[idxNotes]:'');
            var phone= norm(idxPhone>=0?r[idxPhone]:'');
            var timeMins = parseTimeToSortable(time);

            return { clientRaw:clientRaw, num:num, pu:pu, time:time, timeMins:timeMins, notes:notes, phone:phone, flyFromCount: flyFromAny };
          });

        ignoredCharter = prepared.filter(function(x){ return /charter/i.test(x.pu); });
        rows = prepared.filter(function(x){ return !/charter/i.test(x.pu) && !/\bweather\s*hold\b/i.test(x.clientRaw); });

        if(ignoredCharter.length){
          pushMsg('Ignored '+ignoredCharter.length+' charter booking(s). Ensure charter boat is not used.','warn');
        }

        el('results').innerHTML='<span class="muted">File loaded. Configure boats, then <b>Allocate</b>.</span>';
        el('download').disabled=true;
        setStatus('Loaded '+rows.length+' rows (ignored '+ignoredCharter.length+' charter). Ready. (v=ripple-chain)');
      }catch(err){
        var host = document.getElementById('results');
        var pre = document.createElement('div'); pre.className='err';
        pre.textContent = 'Parse error: '+(err && err.stack ? err.stack : String(err));
        host.prepend(pre);
        setStatus('Error while reading CSV.');
      }
    };
    reader.readAsText(f);
  });
}

/* ========= Boot ========= */
function init(){
  try{
    boats = cloneBoats();
    renderBoats();
    wire();
    setStatus('Ready.');
  }catch(e){
    var host = document.getElementById('results');
    var pre = document.createElement('div');
    pre.className='err';
    pre.textContent='Init error: '+(e&&e.stack?e.stack:String(e));
    host.prepend(pre);
  }
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
</script>
</body>
</html>
