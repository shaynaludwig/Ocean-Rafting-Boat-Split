<!DOCTYPE html>
<html lang="en">
<head> 
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ocean Rafting — Boat Split</title>

<!-- pdf.js for PDF input (text-based PDFs only) -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
<script>
  // point pdf.js to its worker
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.js';
  }
</script>

<style>
  :root{
    --bg:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --panel:#ffffff;
    --brand:#2563eb; --brand-600:#1d4ed8; --shadow:0 6px 18px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       scrollbar-gutter:stable both-edges;}
  header{padding:18px 20px;border-bottom:1px solid var(--line);background:#fff}
  header h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px}
  header p{margin:2px 0 0;color:var(--muted);font-size:13px}
  .container{max-width:1120px;margin:0 auto;padding:20px 16px 32px;}
  .section{background:var(--panel);border:1px solid var(--line);border-radius:12px;
           padding:16px;box-shadow:var(--shadow);margin-bottom:16px;}
  .section-title{margin:0 0 12px;font-weight:800;letter-spacing:.2px;font-size:13px;color:#374151;text-transform:uppercase;}
  label{display:block;margin:8px 0 6px;color:#374151}
  input[type="file"],select,input[type="number"],input[type="text"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);
    background:#fff;color:#111827;outline:none
  }
  input[type="file"]{padding:8px 10px}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;
       border:1px solid var(--line);background:#fff;color:#111827;cursor:pointer;text-decoration:none}
  .btn:hover{background:#f3f4f6}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-primary:hover{background:var(--brand-600)}
  .btn-danger{background:#fff;border-color:#fca5a5;color:#b91c1c}
  .btn-danger:hover{background:#fee2e2}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .boats{display:grid;gap:10px;grid-template-columns:1fr}
  @media(min-width:680px){.boats{grid-template-columns:1fr 1fr}}
  @media(min-width:980px){.boats{grid-template-columns:1fr 1fr 1fr}}
  .boat{border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .just{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .boat h4{margin:0 0 6px;font-size:15px}
  .controls-inline{display:flex;gap:6px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>*{flex:1 1 120px}
  .row-tight{gap:6px}
  .tagline label{display:flex;align-items:center;gap:6px;margin:0}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:#eef2ff;border:1px solid #c7d2fe;color:#1f2937;
        padding:5px 8px;border-radius:999px;font-size:12px;white-space:nowrap}
  .pill{display:inline-block;padding:4px 9px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  .tag{background:#eff6ff;border-color:#bfdbfe;color:#1e3a8a}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:#f3f4f6;color:#111827;text-align:left;font-weight:800;border-bottom:1px solid var(--line);padding:10px 8px}
  tbody td{border-bottom:1px solid var(--line);padding:10px 8px}
  tbody tr:nth-child(2n){background:#fafafa}
  tbody tr:hover{background:#f5f5f5}
  .err{white-space:pre-wrap;background:#fff1f2;color:#881337;border:1px solid #fecdd3;border-radius:10px;padding:10px;margin:12px 0}
</style>
</head>
<body>
<header>
  <h1>Boat Split</h1>
  <p>Upload CSV/PDF → tag boats (DDI / Fly / EE) → remove boats (×) → Allocate → Download CSV</p>
</header>

<main class="container" id="app">
  <div class="section">
    <div class="section-title">Upload file</div>
    <input type="file" id="file" accept=".csv,.pdf,application/pdf" />
    <div class="muted" style="margin-top:6px">
      Columns expected (flexible names): <span class="mono chip">Client</span> <span class="mono chip">No. Pass.</span>
      <span class="mono chip">P/U Point</span> <span class="mono chip">Time</span> <span class="mono chip">Pickup Notes</span>
      <span class="mono chip">Phone</span>
      <div style="margin-top:4px">PDF support is beta and works best with text-based, table-like PDFs (not scans).</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Tour & actions</div>
    <div class="row">
      <label style="max-width:280px">Tour
        <select id="tour"><option value="north">Northern</option><option value="south">Southern</option></select>
      </label>
    </div>
    <div class="toolbar">
      <button id="resetBoats" class="btn">Reset boats</button>
      <button id="run" class="btn btn-primary">Allocate</button>
      <button id="download" class="btn" disabled>Download CSV</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px">Booting…</div>
    <div id="messages" class="chips" style="margin-top:10px"></div>
  </div>

  <div class="section">
    <div class="section-title">Boats in order (earliest → latest)</div>
    <div class="muted" style="margin-bottom:8px">
      Reorder (▲/▼), set tags (DDI / Fly-Raft / EE), hold seats, or remove with ×. DDI & Fly are mutually exclusive.
    </div>
    <div id="boats" class="boats"></div>
  </div>

  <div class="section">
    <div class="section-title">Results</div>
    <div id="results" class="muted">Upload a CSV/PDF and click <b>Allocate</b>.</div>
  </div>
</main>

<script>
"use strict";

/* ========= Error banner ========= */
window.onerror = (msg, src, line, col, err) => {
  const host = document.querySelector('#results');
  const pre = document.createElement('div');
  pre.className = 'err';
  pre.textContent = `Script error:\n${msg}\n${src?('at '+src+':'+line+':'+col):''}\n` + (err&&err.stack?err.stack:'');
  host?.prepend(pre);
};

/* ========= Helpers ========= */
const el = id => document.getElementById(id);
const setStatus = s => { const n=el('status'); if(n) n.textContent = s; };
const messagesEl = document.getElementById('messages');
function clearMsgs(){ if(messagesEl) messagesEl.innerHTML=''; }
function pushMsg(text,tone=''){
  if(!messagesEl) return;
  const m=document.createElement('span'); m.className='chip';
  const col = tone==='ok'?'#16a34a':tone==='warn'?'#f59e0b':tone==='bad'?'#ef4444':'#c7d2fe';
  m.style.borderColor=col; m.textContent=text; messagesEl.appendChild(m);
}
function norm(s){ return (s??'').toString().trim(); }
function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function edgeOrder(n){ const res=[]; for(let a=0,b=n-1;a<=b;a++,b--){ res.push(a); if(b>a) res.push(b);} return res; }

/* ========= Defaults ========= */
const DEFAULT_BOATS = [
  { name: "Joyride",        seats: 32, toilet: true },
  { name: "Thunderstruck",  seats: 32, toilet: true },
  { name: "Black Betty",    seats: 32, toilet: true },
  { name: "Wipeout",        seats: 32, toilet: true },
  { name: "Riptide",        seats: 32, toilet: true },
  { name: "Thrilla",        seats: 25, toilet: false },
  { name: "Jammin",         seats: 22, toilet: true },
  { name: "Wildthing",      seats: 19, toilet: false },
];
let boats = [];
let rows = [];
let ignoredCharter = [];
let popups = [];

/* ========= CSV parsing ========= */
function parseCSV(text){
  const rows=[]; let cur='',row=[],inQ=false; let i=0;
  while(i<text.length){ const ch=text[i];
    if(inQ){ if(ch==='"'){ if(text[i+1]==='"'){cur+='"';i+=2;continue} inQ=false;i++;continue } cur+=ch; i++; continue; }
    if(ch==='"'){ inQ=true; i++; continue; }
    if(ch===','){ row.push(cur); cur=''; i++; continue; }
    if(ch==='\r'){ i++; continue; }
    if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; i++; continue; }
    cur+=ch; i++;
  }
  row.push(cur); rows.push(row);
  return rows.filter(r => r.some(c => norm(c) !== ''));
}
const COL_ALIASES = {
  client:["client","name","full name","passenger","pax name"],
  num:["no. pass.","no pass","passengers","pax","qty","count"],
  pu:["p/u point","pickup point","p/u","pick up","pickup","location","p/u address","pickup address"],
  time:["time","pickup time","p/u time"],
  notes:["pickup notes","notes","comments","pu comments","p/u notes"],
  phone:["phone","mobile"]
};
function findColIndex(h,keys){
  const lower=h.map(x=>x.toLowerCase());
  for(const k of keys){ const i=lower.indexOf(k); if(i!==-1) return i; }
  for(let i=0;i<lower.length;i++){ if(keys.some(k=>lower[i].includes(k))) return i; }
  return -1;
}
function parseTimeToSortable(t){
  if(!t) return null; let s=t.toString().trim(); if(!s) return null;
  s=s.replace('.',':'); const ampm=/am|pm/i.test(s)?s.match(/am|pm/i)[0].toLowerCase():null;
  s=s.replace(/[^0-9:]/g,''); if(/^\d{3,4}$/.test(s)){ s=(s.length===3?'0'+s:s); s=s.slice(0,2)+':'+s.slice(2); }
  if(!/^\d{1,2}:\d{2}$/.test(s)) return null;
  let [hh,mm]=s.split(':').map(n=>parseInt(n,10)); if(ampm){ if(ampm==='pm'&&hh<12)hh+=12; if(ampm==='am'&&hh===12)hh=0; }
  if(hh>=0&&hh<24&&mm>=0&&mm<60) return hh*60+mm; return null;
}
function quartileSection(mins, sortedDistinct){
  if(mins==null) return 'Unknown'; const n=sortedDistinct.length; if(!n) return 'Unknown';
  const q1=sortedDistinct[Math.floor(n*.25)], q2=sortedDistinct[Math.floor(n*.50)], q3=sortedDistinct[Math.floor(n*.75)];
  if(mins<=q1) return '1st'; if(mins<=q2) return '2nd'; if(mins<=q3) return '3rd'; return '4th';
}

/* ========= Boat colors ========= */
function boatStyleForName(name){
  const n=(name||'').toLowerCase();
  if(n.includes('joyride'))       return { bg:'#ddd6fe', fg:'#1f2937', br:'#c4b5fd' };
  if(n.includes('black betty'))   return { bg:'#111827', fg:'#ffffff', br:'#0b0f1a' };
  if(n.includes('thunderstruck')) return { bg:'#fecaca', fg:'#1f2937', br:'#fca5a5' };
  if(n.includes('wipeout'))       return { bg:'#ffffff', fg:'#111827', br:'#e5e7eb' };
  if(n.includes('thrilla'))       return { bg:'#fef3c7', fg:'#1f2937', br:'#fde68a' };
  if(n.includes('jammin'))        return { bg:'#dcfce7', fg:'#1f2937', br:'#bbf7d0' };
  if(n.includes('wildthing'))     return { bg:'#dbeafe', fg:'#1f2937', br:'#bfdbfe' };
  if(n.includes('riptide'))       return { bg:'#f1f5f9', fg:'#1f2937', br:'#e2e8f0' };
  return { bg:'#ffffff', fg:'#111827', br:'#e5e7eb' };
}

/* ========= Boats UI ========= */
function cloneBoats(){ return DEFAULT_BOATS.map(b=>({...b, tagDDI:false, tagFly:false, tagEE:false, hold:0 })); }

function renderBoats(){
  const wrap = document.getElementById('boats');
  if (!wrap) { setStatus('Boats container missing.'); return; }
  try{
    wrap.innerHTML='';
    if(!boats || !Array.isArray(boats)) boats = [];
    if(!boats.length) boats = cloneBoats();

    boats.forEach((b,idx)=>{
      const style = boatStyleForName(b.name);
      const box=document.createElement('div'); box.className='boat';
      box.style.background = style.bg;
      box.style.color = style.fg;
      box.style.borderColor = style.br;

      box.innerHTML=`
        <div class="just">
          <div>
            <h4 style="color:${style.fg}">${idx+1}. ${b.name} ${b.toilet?'🚻':''}</h4>
            <div style="font-size:12px; color:${style.fg}">${b.seats} seats${b.toilet?', toilet':''}</div>
          </div>
          <div class="controls-inline">
            <button class="btn" data-act="up" data-idx="${idx}" title="Earlier">▲</button>
            <button class="btn" data-act="down" data-idx="${idx}" title="Later">▼</button>
            <button class="btn btn-danger" data-act="remove" data-idx="${idx}" title="Remove boat">×</button>
          </div>
        </div>
        <div class="row row-tight" style="margin-top:8px; align-items:center">
          <div class="tagline" style="display:flex; gap:10px; flex-wrap:wrap">
            <label><input type="checkbox" data-act="ddi" data-idx="${idx}" ${b.tagDDI?'checked':''}/> DDI</label>
            <label><input type="checkbox" data-act="fly" data-idx="${idx}" ${b.tagFly?'checked':''}/> Fly-Raft</label>
            <label><input type="checkbox" data-act="ee"  data-idx="${idx}" ${b.tagEE?'checked':''}/> EE</label>
          </div>
          <div style="flex:1"></div>
          <label style="margin:0; flex:0 0 160px">Hold seats
            <input type="number" data-act="hold" data-idx="${idx}" min="0" max="${b.seats}" value="${b.hold||0}" />
          </label>
        </div>
      `;
      wrap.appendChild(box);
    });

    wrap.querySelectorAll('button').forEach(btn=>{
      btn.onclick=()=>{
        const idx=+btn.dataset.idx, act=btn.dataset.act;
        if(act==='up'&&idx>0){ [boats[idx-1],boats[idx]]=[boats[idx],boats[idx-1]]; renderBoats(); }
        if(act==='down'&&idx<boats.length-1){ [boats[idx+1],boats[idx]]=[boats[idx],boats[idx+1]]; renderBoats(); }
        if(act==='remove'){ boats.splice(idx,1); renderBoats(); setStatus('Boat removed.'); }
      };
    });
    wrap.querySelectorAll('input').forEach(inp=>{
      inp.onchange=()=>{
        const idx=+inp.dataset.idx, act=inp.dataset.act;
        if(act==='ddi'){ boats[idx].tagDDI=inp.checked; if(inp.checked) boats[idx].tagFly=false; }
        if(act==='fly'){ boats[idx].tagFly=inp.checked; if(inp.checked) boats[idx].tagDDI=false; }
        if(act==='ee'){ boats[idx].tagEE=inp.checked; }
        if(act==='hold'){
          let v=parseInt(inp.value||'0',10); v=isNaN(v)?0:v;
          v=Math.max(0,Math.min(v,boats[idx].seats)); boats[idx].hold=v; inp.value=String(v);
        }
        renderBoats();
      };
    });
  }catch(e){
    const errBox=document.createElement('div');
    errBox.className='err';
    errBox.textContent='Boats render error: '+ (e && e.stack ? e.stack : String(e));
    wrap.parentElement.prepend(errBox);
  }
}

/* ========= Allocation ========= */
function allocate(){
  clearMsgs(); popups = [];
  if(!rows.length){ setStatus('Please upload a CSV/PDF first.'); return; }
  if(!boats.length){ setStatus('No boats in use. Click "Reset boats".'); return; }

  const B = boats.map(b=>({
    name:b.name,seats:b.seats,toilet:b.toilet,
    tagDDI:!!b.tagDDI, tagFly:!!b.tagFly, tagEE:!!b.tagEE,
    hold: Math.max(0,Math.min(b.hold||0,b.seats)),
    pax:[], count:0, twGroups:new Set(), mapGroupCount:0
  }));
  const eff = b => Math.max(0,b.seats-b.hold);
  const edges = edgeOrder(B.length);
  const lastIdx = edges[1] ?? (B.length-1);
  const edgeBoats = edges.map(i=>({i,b:B[i]}));
  const tagOrder = tag => edgeBoats.filter(o=>o.b[`tag${tag}`]).sort((a,b)=>edges.indexOf(a.i)-edges.indexOf(b.i));
  function sectionEdgeOrder(section){
    if(section==='1st'||section==='2nd'){ const wl = edges.filter(i=>i!==lastIdx); return [...wl,lastIdx]; }
    return edges;
  }
  function addPax(i,r,tags=[],hl=[]){
    const need=r.num||1; const b=B[i];
    b.pax.push({row:r,count:need,tags:new Set(tags),highlights:new Set(hl)});
    b.count+=need;
  }

  const distinct=[...new Set(rows.map(r=>r.timeMins).filter(v=>v!=null))].sort((a,b)=>a-b);
  rows.forEach(r=>r.section = quartileSection(r.timeMins, distinct));

  // classification helpers
  const isDDI   = r => /daydream\s*island/i.test(r.pu);
  const isOwn   = r => /(own\s*way|tbc|not\s*sure|tba)/i.test(r.pu);
  const isEE    = r => /\bee\b/i.test(r.notes||'');
  const noteFly = r => /(fly[-\s]*raft|fly\s*raft)/i.test(r.notes||'');
  const hasFR   = r => /\(\s*F\s*\+\s*R\s*\)/i.test(r.clientRaw) || r.flyFromCount || noteFly(r);
  const earlyBoat = r => /early\s*boat/i.test(r.notes||'');
  const charter = r => /charter/i.test(r.pu);
  const wHoldName = r => /\bweather\s*hold\b/i.test(r.clientRaw);
  const isMAP = r => /\b(?:\*?MAP\*?|my\s*adv\s*proj)\b/i.test(r.clientRaw);

  // rows: remove WEATHER HOLD and charter, but record charter for warning
  const prepared = rows.slice();
  ignoredCharter = prepared.filter(r=>charter(r));
  const filtered = prepared.filter(r=>!wHoldName(r) && !charter(r));
  const unassigned = new Set(filtered);

  // ====== *TW* parsing/indexing ======
  function baseName(clientRaw){ return norm(clientRaw.replace(/\*TW\*.*$/i,'')); }
  function parseTW(row){ const m = row.clientRaw.match(/\*TW\*\s*(.+)$/i); return m?norm(m[1]):null; }
  const byName = new Map();
  filtered.forEach(r=>{
    r.nameClean = baseName(r.clientRaw);
    r.twPartner = parseTW(r);
    byName.set(r.nameClean, (byName.get(r.nameClean)||[]).concat([r]));
  });
  const twGroups = new Map(); const twErrors=[];
  filtered.forEach(r=>{
    if(!r.twPartner) return;
    const anchor = norm(r.twPartner);
    const partners = byName.get(anchor) || [];
    if(partners.length===0){ twErrors.push(`*TW* reference not found: "${r.clientRaw}" → "${anchor}"`); return; }
    if(partners.length>1){ twErrors.push(`*TW* ambiguous anchor: "${anchor}" — please disambiguate.`); return; }
    const arr = twGroups.get(anchor)||[];
    if(!arr.includes(partners[0])) arr.push(partners[0]);
    if(!arr.includes(r)) arr.push(r);
    twGroups.set(anchor, arr);
  });
  if(twErrors.length){ popups.push(twErrors.join('\n')); }

  filtered.forEach(r=>{ if(isDDI(r)) r.section='1st'; if(hasFR(r)) r.section='Unknown'; });

  /* ===== 1) DDI STRICT ===== */
  let ddiBoats = tagOrder('DDI');
  const ddiRows = filtered.filter(isDDI);
  if(ddiRows.length && ddiBoats.length===0 && B.length){
    B[0].tagDDI=true; ddiBoats=tagOrder('DDI'); pushMsg('Auto-tagged earliest boat as DDI.','warn');
  }
  const ddiCap = ddiBoats.reduce((s,o)=>s+(eff(o.b)-o.b.count),0);
  const ddiNeed = ddiRows.reduce((s,r)=>s+(r.num||1),0);
  if(ddiNeed>ddiCap) popups.push('Not enough space on DDI boat(s). Tag another DDI or redo run sheet.');
  for(const r of ddiRows){
    if(!unassigned.has(r)) continue; const need=r.num||1;
    for(const {i} of ddiBoats){
      const b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,['DDI']); unassigned.delete(r); break; }
    }
  }

  /* ===== 2) F+R STRICT ===== */
  const flyRows = filtered.filter(r=>hasFR(r) && !earlyBoat(r))
    .sort((a,b)=>{
      const rank = s => ({'Unknown':0,'4th':1,'3rd':2,'2nd':3,'1st':4}[s] ?? 5);
      const ra=rank(a.section), rb=rank(b.section); if(ra!==rb) return ra-rb;
      return (b.timeMins??-1)-(a.timeMins??-1);
    });
  let flyBoats = tagOrder('Fly');
  if(flyRows.length && flyBoats.length===0){
    const last = edges[1] ?? (B.length-1); B[last].tagFly=true; flyBoats=tagOrder('Fly');
    pushMsg('No Fly boat tagged — auto-tagged latest boat.','warn');
  }
  const flyCap = flyBoats.reduce((s,o)=>s+(eff(o.b)-o.b.count),0);
  const flyNeed = flyRows.reduce((s,r)=>s+(r.num||1),0);
  if(flyNeed>flyCap) popups.push('Not enough space on Fly-Raft boat(s). Tag another Fly-Raft or redo run sheet.');
  for(const r of flyRows){
    if(!unassigned.has(r)) continue; const need=r.num||1; let placed=false;
    for(const {i} of flyBoats.slice().reverse()){
      const b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,['F+R']); unassigned.delete(r); placed=true; break; }
    }
  }

  /* ===== SWAP HELPER (generalised) ===== */
  function sectionRank(s){ return {'Unknown':0,'4th':1,'3rd':2,'2nd':3,'1st':4}[s] ?? 0; }
  function tryMakeRoomWithSwap(targetIdx, need, refSec, requireFly){
    const target = B[targetIdx];
    const refRank = sectionRank(refSec);
    const laterIdx = edges.filter(i => i > targetIdx);
    let freed = 0;
    for(let k = target.pax.length - 1; k >= 0 && freed < need; k--){
      const entry = target.pax[k];
      const row = entry.row;
      const cnt = entry.count;
      const donorRank = sectionRank(row.section);
      const donorIsDDI = entry.tags.has('DDI') || isDDI(row);
      const donorIsFR  = entry.tags.has('F+R') || (/\(\s*F\s*\+\s*R\s*\)/i.test(row.clientRaw) || row.flyFromCount || noteFly(row));
      const donorIsTW  = Array.from(entry.highlights||[]).some(h => h.includes('*TW* grouped'));
      const donorIsMAP = Array.from(entry.highlights||[]).some(h => h.includes('MAP grouped'));
      if(donorRank >= refRank) continue;
      if(donorIsDDI || donorIsTW || donorIsMAP) continue; // never move protected groups
      for(const j of laterIdx){
        const land = B[j];
        if(land.tagDDI) continue;
        if(donorIsFR && !land.tagFly) continue;
        if(land.count + cnt <= eff(land)){
          target.pax.splice(k,1); target.count -= cnt;
          addPax(j, row, [...entry.tags], [...entry.highlights, 'SWAP (freed earlier boat)']);
          freed += cnt; break;
        }
      }
    }
    return freed >= need;
  }

  /* ===== 3) *TW* AFTER DDI & F+R ===== */
  function referenceMember(arr){
    const known = arr.filter(r=>r.section && r.section!=='Unknown');
    if(!known.length) return null;
    return known.sort((a,b)=>{
      const ra=sectionRank(a.section), rb=sectionRank(b.section);
      if(rb!==ra) return rb-ra;
      return (b.timeMins??-1) - (a.timeMins??-1);
    })[0];
  }
  function isFRRow(r){ return hasFR(r); }
  function isDDIRow(r){ return isDDI(r); }

  for(const [anchor, groupRaw] of new Map(twGroups)){
    const group = Array.from(new Set(groupRaw));
    if(group.some(isDDIRow)){
      popups.push(`*TW* group with "${anchor}" includes a DDI passenger. Consider changing PU times to keep them together.`);
      continue;
    }
    const need = group.reduce((s,r)=>s+(r.num||1),0);
    const anyFR = group.some(isFRRow);
    const ref = referenceMember(group);
    let candidates = [];
    if(anyFR){
      const flyIdx = tagOrder('Fly').map(x=>x.i);
      if(!flyIdx.length){ popups.push(`*TW* group "${anchor}" requires Fly-Raft but no Fly boat is tagged.`); continue; }
      if(ref && (ref.section==='1st'||ref.section==='2nd')) candidates = flyIdx.slice(); else candidates = flyIdx.slice().reverse();
    }else{
      const notDDI = edges.filter(i=>!B[i].tagDDI);
      if(ref && (ref.section==='1st'||ref.section==='2nd')){
        const last = edges[1] ?? (B.length-1);
        candidates = notDDI.filter(i=>i!==last);
      }else if(ref && (ref.section==='3rd'||ref.section==='4th')){
        candidates = notDDI.slice().reverse();
      }else{
        candidates = notDDI.slice(1);
      }
    }
    let placedIdx = null;
    for(const i of candidates){
      const b = B[i];
      const capLeft = eff(b) - b.count;
      if(capLeft >= need){ placedIdx = i; break; }
      const ok = tryMakeRoomWithSwap(i, need - capLeft, ref ? ref.section : 'Unknown', anyFR);
      if(ok){ placedIdx = i; break; }
    }
    if(placedIdx==null){
      popups.push(`*TW* group "${anchor}" could not fit on target boat(s)${anyFR?' (Fly-Raft)':''} even after swaps. Tag another boat, reduce holds, or adjust numbers.`);
      continue;
    }
    for(let bi=0; bi<B.length; bi++){
      const p=B[bi].pax;
      for(let k=p.length-1; k>=0; k--){
        if(group.includes(p[k].row)){ const rem=B[bi].pax.splice(k,1)[0]; B[bi].count -= rem.count; }
      }
    }
    for(const r of group){
      const tags=[]; if(isFRRow(r)) tags.push('F+R'); if(isEE(r)) tags.push('EE'); if(isDDIRow(r)) tags.push('DDI');
      addPax(placedIdx, r, tags, ['*TW* grouped (anchored to partner’s section)']);
      unassigned.delete(r);
    }
    B[placedIdx].twGroups.add(anchor);
  }

  /* ===== 3b) MAP GROUP (after TW) ===== */
  (function(){
    const mapGroup = filtered.filter(r => isMAP(r) && unassigned.has(r));
    if(!mapGroup.length) return;
    const need = mapGroup.reduce((s,r)=>s+(r.num||1),0);
    const anyFR = mapGroup.some(isFRRow);
    const anyDDI = mapGroup.some(isDDIRow);
    const ref = referenceMember(mapGroup);

    let candidates = [];
    if(anyDDI){
      const ddiIdx = tagOrder('DDI').map(x=>x.i);
      if(!ddiIdx.length){ popups.push('MAP group includes DDI pax but no DDI boat is tagged.'); return; }
      candidates = (ref && (ref.section==='1st'||ref.section==='2nd')) ? ddiIdx.slice() : ddiIdx.slice().reverse();
    } else if(anyFR){
      const flyIdx = tagOrder('Fly').map(x=>x.i);
      if(!flyIdx.length){ popups.push('MAP group requires Fly-Raft but no Fly boat is tagged.'); return; }
      candidates = (ref && (ref.section==='1st'||ref.section==='2nd')) ? flyIdx.slice() : flyIdx.slice().reverse();
    } else {
      const notDDI = edges.filter(i=>!B[i].tagDDI);
      if(ref && (ref.section==='1st'||ref.section==='2nd')){
        const last = edges[1] ?? (B.length-1);
        candidates = notDDI.filter(i=>i!==last);
      } else if(ref && (ref.section==='3rd'||ref.section==='4th')){
        candidates = notDDI.slice().reverse();
      } else {
        candidates = notDDI.slice(1);
      }
    }

    let placedIdx = null;
    for(const i of candidates){
      const b = B[i];
      const capLeft = eff(b) - b.count;
      if(capLeft >= need){ placedIdx = i; break; }
      const ok = tryMakeRoomWithSwap(i, need - capLeft, ref ? ref.section : 'Unknown', anyFR);
      if(ok){ placedIdx = i; break; }
    }
    if(placedIdx==null){
      popups.push('MAP group could not fit on target boat(s) even after swaps. Consider freeing capacity or tagging another compatible boat.');
      return;
    }

    for(const r of mapGroup){
      const tags=[]; if(isFRRow(r)) tags.push('F+R'); if(isEE(r)) tags.push('EE'); if(isDDIRow(r)) tags.push('DDI'); tags.push('MAP');
      addPax(placedIdx, r, tags, ['MAP grouped']);
      unassigned.delete(r);
    }
    B[placedIdx].mapGroupCount += need;
  })();

  /* ===== 4) EE ===== */
  let eeBoats = tagOrder('EE');
  for(const r of filtered.filter(rr=>isEE(rr) && unassigned.has(rr))){
    const need=r.num||1;
    const earlyEE = (r.section==='1st'||r.section==='2nd');
    if(earlyEE && B.length>=3){
      let placed=false;
      for(const i of sectionEdgeOrder(r.section)){
        const b=B[i];
        if(b.count+need<=eff(b)){
          const hl = (r.section==='1st') ? ['EE kept early (1st section)'] : [];
          addPax(i,r,['EE'],hl);
          unassigned.delete(r);
          placed=true; break;
        }
      }
      if(placed) continue;
    }
    let placed=false;
    const eeLate = eeBoats.length?eeBoats.slice().reverse():[{i:lastIdx}];
    for(const {i} of eeLate){
      const b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,['EE'],[earlyEE?'Early EE moved later':'']); unassigned.delete(r); placed=true; break; }
    }
    if(!placed){
      for(const {i} of edgeBoats){
        const b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,['EE'],['EE by capacity']); unassigned.delete(r); break; }
      }
    }
  }

  /* ===== 5) Baseline fill ===== */
  const orderSec={'1st':0,'2nd':1,'3rd':2,'4th':3,'Unknown':4};
  [...unassigned].sort((a,b)=>{
    const da=orderSec[a.section]??4, db=orderSec[b.section]??4;
    if(da!==db) return da-db;
    return (a.timeMins??1e9)-(b.timeMins??1e9);
  }).forEach(r=>{
    const need=r.num||1; let placed=false;
    for(const i of sectionEdgeOrder(r.section)){
      const b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r); placed=true; break; }
    }
    if(!placed){
      for(const {i} of edgeBoats){
        const b=B[i]; if(b.count+need<=eff(b)){ addPax(i,r,[],['Capacity fallback']); placed=true; break; }
      }
    }
    if(placed) unassigned.delete(r);
  });

  /* ===== 6) FINAL FIT — swap pass for any remainder ===== */
  const still = [...unassigned];
  for(const r of still){
    const need=r.num||1;
    let landed=false;
    for(const i of sectionEdgeOrder(r.section)){
      const capLeft = eff(B[i]) - B[i].count;
      if(capLeft>=need){ addPax(i,r,[],['Final-fit']); landed=true; break; }
      const ok = tryMakeRoomWithSwap(i, need - capLeft, r.section, hasFR(r));
      if(ok){ addPax(i,r,[],['Final-fit (swap)']); landed=true; break; }
    }
    if(landed) unassigned.delete(r);
  }

  /* ===== Render output ===== */
  const out=[["Boat","DepartureOrder","Boat Hold Seats","Boat Tags","Client","No. Pass.","P/U Point","Time","Pickup Notes","Phone","Tags","Highlights","Pickup Section"]];
  const results = el('results'); results.innerHTML='';
  let grandTotal=0, totalEffCap=0;

  if(ignoredCharter.length){
    const warn=document.createElement('div');
    warn.className='err';
    const list = ignoredCharter.slice(0,10).map(c=>`• ${escapeHtml(c.clientRaw)} (PU: ${escapeHtml(c.pu)})`).join('\n');
    warn.textContent = `Ignored ${ignoredCharter.length} charter booking(s) — please ensure the charter boat is not being used.\n\nExamples:\n${list}${ignoredCharter.length>10?'\n…':''}`;
    results.appendChild(warn);
  }

  B.forEach((b,idx)=>{
    grandTotal+=b.count; totalEffCap+=eff(b);
    const boatTags=[b.tagDDI?'DDI':'', b.tagFly?'Fly-Raft':'', b.tagEE?'EE':''].filter(Boolean).join('; ');
    const head=document.createElement('div');
    head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
    head.style.margin='8px 0 4px';
    head.innerHTML = `<div><b>${idx+1}. ${b.name}</b> &nbsp; <span class="pill ${b.count<=eff(b)?'ok':'bad'}">${b.count}/${eff(b)}</span></div>
      <div class="chips">
        ${b.tagDDI?'<span class="chip">DDI</span>':''}
        ${b.tagFly?'<span class="chip">Fly-Raft</span>':''}
        ${b.tagEE?'<span class="chip">EE</span>':''}
        ${b.twGroups.size?`<span class="chip">TW groups: ${b.twGroups.size}</span>`:''}
        ${b.mapGroupCount?`<span class="chip">MAP pax: ${b.mapGroupCount}</span>`:''}
        ${b.toilet?'<span class="chip">🚻</span>':''}
      </div>`;
    results.appendChild(head);

    const table=document.createElement('table');
    table.innerHTML = `<thead><tr>
      <th>#</th><th>Client</th><th>No. Pass.</th><th>P/U Point</th><th>Time</th><th>Section</th><th>Tags</th><th>Highlights</th>
    </tr></thead>`;
    const tb=document.createElement('tbody');

    if(b.hold>0){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>—</td><td>SEAT HOLD</td><td>${b.hold}</td>
        <td></td><td></td><td></td>
        <td><span class="pill tag">Hold</span></td>
        <td><span class="pill warn">Seats reserved; not for allocation</span></td>`;
      tb.appendChild(tr);
      out.push([b.name,idx+1,b.hold,boatTags,'SEAT HOLD',b.hold,'','','','','Hold','Seats reserved; not for allocation','']);
    }

    b.pax.forEach((p,i)=>{
      const tags=[...p.tags], hl=[...p.highlights];
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(p.row.clientRaw)}</td>
        <td>${p.count}</td>
        <td>${escapeHtml(p.row.pu)}</td>
        <td>${p.row.time||''}</td>
        <td>${p.row.section}</td>
        <td>${tags.map(t=>`<span class="pill tag">${t}</span>`).join(' ')}</td>
        <td>${hl.filter(Boolean).map(t=>`<span class="pill warn">${escapeHtml(t)}</span>`).join(' ')}</td>`;
      tb.appendChild(tr);
      out.push([b.name,idx+1,b.hold,boatTags,p.row.clientRaw,p.count,p.row.pu,p.row.time||'',p.row.notes||'',p.row.phone||'',tags.join('; '),hl.filter(Boolean).join('; '),p.row.section]);
    });
    table.appendChild(tb);
    results.appendChild(table);
  });

  /* ===== Overflow / Holding boat ===== */
  const overflow = [...unassigned];
  if(overflow.length){
    const head=document.createElement('div');
    head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
    head.style.margin='12px 0 6px';
    head.innerHTML = `<div><b>⚠ Overflow (Review)</b> &nbsp; <span class="pill bad">${overflow.reduce((s,r)=>s+(r.num||1),0)} pax</span></div>
      <div class="chips"><span class="chip">Unplaced — adjust holds/tags or add boat</span></div>`;
    results.appendChild(head);

    const table=document.createElement('table');
    table.innerHTML = `<thead><tr>
      <th>#</th><th>Client</th><th>No. Pass.</th><th>P/U Point</th><th>Time</th><th>Section</th><th>Tags</th><th>Why</th>
    </tr></thead>`;
    const tb=document.createElement('tbody');
    overflow.forEach((r,i)=>{
      const tags=[];
      if(isDDI(r)) tags.push('DDI');
      if(hasFR(r)) tags.push('F+R');
      if(isEE(r))  tags.push('EE');
      if(isMAP(r)) tags.push('MAP');
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(r.clientRaw)}</td>
        <td>${r.num||1}</td>
        <td>${escapeHtml(r.pu)}</td>
        <td>${r.time||''}</td>
        <td>${r.section}</td>
        <td>${tags.map(t=>`<span class="pill tag">${t}</span>`).join(' ')}</td>
        <td><span class="pill bad">No capacity after swaps</span></td>`;
      tb.appendChild(tr);
      out.push(['OVERFLOW', '', '', '', r.clientRaw, r.num||1, r.pu, r.time||'', r.notes||'', r.phone||'', tags.join('; '), 'Unplaced after swap-pass', r.section]);
    });
    table.appendChild(tb); results.appendChild(table);
  }

  const summary=document.createElement('div'); summary.className='status';
  summary.style.margin='10px 0 0';
  const totalOverflow = overflow.reduce((s,r)=>s+(r.num||1),0);
  summary.innerHTML = `Total allocated: <b>${grandTotal}</b> / Effective capacity: <b>${totalEffCap}</b>${grandTotal>totalEffCap?' <span class="pill bad">Over capacity</span>':''}
  ${totalOverflow?` — Overflow (review): <b>${totalOverflow}</b>`:''}`;
  results.prepend(summary);

  // CSV Download
  const safeToCSV = rows => rows.map(r=>r.map(v=>{
    if(v==null) return '';
    const s=String(v);
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }).join(',')).join('\n');
  const csv = safeToCSV(out);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const dl=document.getElementById('download');
  dl.onclick=()=>{ const stamp=new Date().toISOString().slice(0,10); const a=document.createElement('a'); a.href=url; a.download=`boat-split-${document.getElementById('tour').value}-${stamp}.csv`; document.body.appendChild(a); a.click(); a.remove(); };
  dl.disabled=false;
  setStatus('Allocation complete.');

  if(popups.length) alert(popups.join('\n\n'));
}

/* ========= File loaders ========= */
async function pdfToGuessedCSVText(file){
  if(!window['pdfjsLib']) throw new Error('pdf.js not loaded');
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  let lines = [];
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const items = content.items.map(it => ({text: it.str, x: Math.round(it.transform[4]), y: Math.round(it.transform[5])}));
    const byY = new Map();
    for(const it of items){
      const key = it.y; if(!byY.has(key)) byY.set(key, []);
      byY.get(key).push(it);
    }
    const ys = [...byY.keys()].sort((a,b)=>b-a); // top→bottom
    ys.forEach(y=>{
      const row = byY.get(y).sort((a,b)=>a.x-b.x).map(it=>it.text).join(' ').trim();
      if(row) lines.push(row);
    });
  }
  // Heuristic: convert runs of 2+ spaces into commas
  const csvGuess = lines.map(line => line.replace(/\s{2,}/g, ',')).join('\n');
  return csvGuess;
}

async function loadFile(e){
  clearMsgs(); popups=[]; ignoredCharter = [];
  const f=e.target.files?.[0]; if(!f) return;

  let raw;
  if((f.type && f.type.toLowerCase().includes('pdf')) || f.name.toLowerCase().endsWith('.pdf')){
    try{
      setStatus('Reading PDF (beta)…');
      const text = await pdfToGuessedCSVText(f);
      raw = parseCSV(text);
      pushMsg(`Parsed PDF (beta): ${raw.length-1} row(s)`, 'ok');
    }catch(err){
      setStatus('Could not parse PDF. Please upload a CSV instead.');
      const host = document.querySelector('#results');
      const pre = document.createElement('div');
      pre.className='err';
      pre.textContent='PDF parse error (beta): '+(err&&err.message?err.message:String(err));
      host?.prepend(pre);
      return;
    }
  }else{
    const text = await f.text();
    raw = parseCSV(text);
  }

  if(!raw.length){ setStatus('Empty file.'); return; }
  const header = raw[0].map(h=>h.trim());
  const data = raw.slice(1);

  const idxClient=findColIndex(header,COL_ALIASES.client);
  const idxNum   =findColIndex(header,COL_ALIASES.num);
  const idxPU    =findColIndex(header,COL_ALIASES.pu);
  const idxTime  =findColIndex(header,COL_ALIASES.time);
  const idxNotes =findColIndex(header,COL_ALIASES.notes);
  const idxPhone =findColIndex(header,COL_ALIASES.phone);

  if(idxClient<0 || idxPU<0){
    setStatus('Missing required columns: need at least Client and P/U Point.');
    return;
  }

  const prepared = data
    .filter(r => r.some(c => norm(c) !== ''))
    .map(r=>{
      const clientRaw = norm(r[idxClient]);
      const numRaw = (r[idxNum]??'').toString();
      const FRfromCount  = /\(\s*F\s*\+\s*R\s*\)/i.test(numRaw);
      const FRfromClient = /\(\s*F\s*\+\s*R\s*\)/i.test(clientRaw);
      const FRfromNotes  = /\(\s*F\s*\+\s*R\s*\)/i.test(norm(idxNotes>=0?r[idxNotes]:'')); 
      const flyFromAny   = FRfromCount || FRfromClient || FRfromNotes;

      const numMatch = numRaw.match(/\d+/);
      const num = Math.max(1, numMatch ? parseInt(numMatch[0],10) : 1);

      const pu   = norm(r[idxPU]);
      const time = norm(idxTime>=0?r[idxTime]:'');
      const notes= norm(idxNotes>=0?r[idxNotes]:'');
      const phone= norm(idxPhone>=0?r[idxPhone]:'');
      const timeMins = parseTimeToSortable(time);

      return { clientRaw, num, pu, time, timeMins, notes, phone, flyFromCount: flyFromAny };
    });

  ignoredCharter = prepared.filter(x=>/charter/i.test(x.pu));
  rows = prepared.filter(x=>!/charter/i.test(x.pu) && !/\bweather\s*hold\b/i.test(x.clientRaw));

  if(ignoredCharter.length){
    pushMsg(`Ignored ${ignoredCharter.length} charter booking(s). Ensure charter boat is not used.`,`warn`);
  }

  el('results').innerHTML='<span class="muted">File loaded. Configure boats, then <b>Allocate</b>.</span>';
  el('download').disabled=true;
  setStatus(`Loaded ${rows.length} rows (ignored ${ignoredCharter.length} charter). Ready. (v=MAP-group+PDF-beta)`);
}

/* ========= Wiring ========= */
function wire(){
  el('resetBoats').onclick=()=>{ boats=cloneBoats(); renderBoats(); setStatus('Boats reset.'); };
  el('run').onclick=allocate;
  el('file').addEventListener('change', loadFile);
}

/* ========= Boot ========= */
function init(){
  try{
    boats = cloneBoats();
    renderBoats();
    wire();
    setStatus('Ready. (v=MAP-group+PDF-beta)');
  }catch(e){
    const host = document.querySelector('#results');
    const pre = document.createElement('div');
    pre.className='err';
    pre.textContent='Init error: '+(e&&e.stack?e.stack:String(e));
    host?.prepend(pre);
  }
}
if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
</script>
</body>
</html>
